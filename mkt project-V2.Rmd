---
title: "Marketing Analytics Project: Black Friday"
author: "Weicheng Zhang, Zilei Zhang, Maura Oray, Gloria Zheng"
output:
  html_document:
    df_print: paged
---

1. Introduction 
Objective:
* Look at the distribution of customer demographics
* Determine which variables are highly correlated with purchase
* Identify which products are high-selling and the characteristics of their customers

The dataset comes from a competition hosted by Analytics Vidhya.

Group Github url: https://github.com/MauraO/Marketing-Analytics-Project
```{r Echo =TRUE,message=FALSE, warning=FALSE}
#Load libraries
library(VIM)
library(readr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(devtools)
devtools::install_github('cttobin/ggthemr')
library(ggthemr)

BF <- read_csv("BlackFriday.csv")
```
2. Data Description
a. Describe the conceptual measure types of the different variables

* User_ID: discrete, nominal
* Product_ID: discrete, nominal
* Gender: discrete, nominal
* Age: discrete, ordinal
* Occupation: discrete, nominal
* City_Category: discrete, nominal
* Stay_in_Current_City_Years: continuous, ratio
* Marital_Status: discrete, nominal
* Product_Category_1: discrete, nominal
* Product_Category_2: discrete, nominal
* Product_Category_3: discrete, nominal
* Purchase: continuous, ratio

* b. Mention all the steps you took to clean the data
* Step 1. Check if the data contains missing values
```{r Echo =TRUE,message=FALSE, warning=FALSE}
sum(complete.cases(BF))
aggr(BF,cex.axis = .4) #164,278 NA values
BF$Product_Category_2[is.na(BF$Product_Category_2)]<- 0 #0 - means the category_2 is missing
BF$Product_Category_3[is.na(BF$Product_Category_3)]<- 0 #0 - means the category_3 is missing
```
In the above visualization, we wanted to see which variables had the most NA values. We saw that the NA values were only concentrated in Product Category 2 and Product Category 3 (red indicates the location of NA values). We thus decided to fill the NA values with "0" as this indicates that there were no sub categories in those rows.

* Step 2. Check the structure of the data
```{r Echo =TRUE, message=FALSE, warning=FALSE}
summary(BF)
str(BF)
```
* Step 3. Type coercion
```{r Echo =TRUE,message=FALSE, warning=FALSE}
BF[1:11] = lapply(BF[1:11], factor)
```
The majority of the variables were either integers or characters. We decided to coerce the variables into factors (all except purchase) because the majority of them are categorical, and coercing to factors makes for easier and clearer analysis.

* Step 4. Tidy the data
```{r Echo =TRUE,message=FALSE, warning=FALSE}
#Select demographic data
demo = BF %>% 
  select(-starts_with("Product")) %>%
  group_by(User_ID) %>%
  mutate(Purchase = sum(Purchase))

#5891 unique customers

demo = demo[!duplicated(demo$User_ID), ]
```
3. Summary statistics and Data Visualizations  
**Customer Demographics**   
* Table 1. Distribution of Gender and Marital Status
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Two-way frequency table showing different combination of customers using gender and marital status  
customer = table(demo$Gender, demo$Marital_Status)
colnames(customer) = c("Unmarried", "Married")
rownames(customer) = c("Female", "Male")

addmargins(customer)
addmargins(prop.table(customer))
```
The two-way frequency table shows 4 combinations of customers. There are 5891 distinct customers in total, and 2470 of them are unmarried males; 1755 are married males; 947 are unmarried females; 719 are married females. 

In this two-way frequency table, we can deduce that there are more unmarried customers (58%) than married (42%) and more male customers (72%) than female (28%). Therefore, in the following analyses regarding gender and marital status, we will focus on customers' average purchase amount instead of the sum purchase, because the sum purchase will easily be influenced by the number of people, which may cause a biased conclusion. 

* Plot 1. Distribution of Purchase
```{r echo=TRUE, message=FALSE, warning=FALSE}
demo %>%
  ggplot(aes(Purchase)) +
  geom_histogram(fill = "#014d64") +
  scale_x_continuous(limits = c(0, 11000000)) +
  theme_economist(base_size=14)+
  scale_fill_economist()+
  labs(x = "Purchase in Dollars", y = "Number of Customers", title = "Purchase Distribution")
```

* Plot 2. Purchase Distribution by Gender and City
```{r message=FALSE, warning=FALSE}
ggthemr('flat dark')
demo %>%
  ggplot(aes(x = Purchase, fill = Gender)) +
  geom_histogram() +
  facet_wrap(~City_Category) +
  scale_x_continuous(limits = c(0, 3000000)) +
  labs(x = "Purchase in Dollars", y = "Number of Customers", title = "Purchase Distribution by Gender and City")+
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
```
* Plot 3. Purchase Distribution by Occupation
```{r message=FALSE, warning=FALSE}
#Create new data frame grouping by occupation and marital status, and taking the mean purchase of each occupation and status.
ggthemr_reset()
demo_occ <- demo %>%
  group_by(Occupation, Marital_Status) %>%
  summarise(Purchase = sum(Purchase)) 

  ggplot(data=demo_occ, aes(x = fct_infreq(Occupation), y = Purchase, fill = Marital_Status)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  coord_flip() +
  labs(x = "Occupation", y = "Purchase in Dollars", title = "Purchase Distribution by Occupation", fill="Marital Status") +
    scale_fill_discrete(labels=c("Unmarried", "Married"))
```
* Plot 4. Purchase Distribution by Age
```{r message=FALSE, warning=FALSE}
ggthemr('sky')
demo %>%
  ggplot(aes(x = Age, y = Purchase)) +
  geom_boxplot() +
  labs(x = "Age", y = "Purchase in Dollars", title = "Purchase Distribution by Age")
```

* Plot 5. Purchase distribution by stay in city years
```{r message=FALSE, warning=FALSE}
ggthemr('sky', layout = 'minimal')
demo %>%
  ggplot(aes(x = Stay_In_Current_City_Years, y = Purchase)) +
  geom_boxplot()+
  labs(x = "Stay in Current City Years", y = "Purchase", title = "Purchase Distribution by Stay Years")
```
* Plot 6. The most popular product category
Product category 1 has three of the most popular products: 5, 1 and 8.
```{r, echo=TRUE, message=FALSE, warning=FALSE}
ggthemr('light', layout = 'clean')
BF_prt = BF %>%
  group_by(Product_ID) %>%
  mutate(sumpp = sum(Purchase), avgpp = mean(Purchase))
BF_prt = BF_prt[-c(3:8)]
BF_prt%>%
  ggplot(aes(x = Product_Category_1))+
  geom_bar(aes(x = fct_infreq(as.factor(Product_Category_1))))+
  labs(x ="Product Category" , y = "Purchase Amount", title = "Product Category Distribution")
  
```
4. Preliminary statistical analyses  
**Do men spend more money on Black Friday than women?**
```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Independent t-test
t.test(demo[demo$Gender == "M", ]$Purchase,
       demo[demo$Gender == "F", ]$Purchase,
       paired = FALSE,
       alternative = "greater")
```
In the above code, we wanted to determine whether gender influences purchase. In table 1 and plot 2, we find that there are more men than women and that men have more purchases than women. Therefore, we want to use an independent t-test to test whether this difference is signficant.  

Based on the evidence from this data set and the result from the t-test (p-value < 2.2e-16), we think the probability that men have same mean purchase as women is less than 5%, and the probability that men have larger mean purchase than women is bigger than 95%. The p-value is very low, therefore, we reject the null hypothesis: that men have the same mean purchase as women, and accept the alternative hypothesis: men do not have the same mean purchase as women, and in fact have larger mean purchase. Moreover, from the sample, we can get the estimated mean purchase of men and women: 911963.2 and 699054.0.

**Do unmarried customers spend more money on Black Friday than married?**
```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Independent t-test
t.test(demo[demo$Marital_Status == 0, ]$Purchase,
       demo[demo$Marital_Status == 1, ]$Purchase,
       paired = FALSE,
       alternative = "greater")
```
In this instance, we want to determine whether marital status influences purchase. In table 1 and plot 3, we find that there are more unmarried people than married, and that unmarried customers seem to make more purchases than married customers. Therefore, we want to use an independent t-test to test whether this difference is significant.  

Based on the evidence from this data set and the result from the t-test (p-value = 0.056), we think the probability that unmarried customers have same mean purchase as married customers is bigger than 5% but less than 10%, and that the probability that unmarried customers have larger mean purchase than married customers is less than 95% but bigger than 90%. Therefore, in the 95% confidence interval, we cannot reject the null hypothesis: that unmarried customers have the same mean purchase as married customers. In the 90% confidence interval, however, we can reject the null hypothesis and accept the alternative hypothesis: that unmarried customers have larger mean purchase than married customers.

**Is there an association between city and purchase?**
```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Chi-Square test
# Create purchase categories
A1 = quantile(demo$Purchase, c(0.33,0.66))
A1
demo = demo %>% 
  mutate(purchase_category = cut(Purchase, breaks = c(-Inf, 304987.6, 826809.6, Inf),
  labels = c("City A", "City B", "City C")))

# Create two-way frequency table
table(demo$City_Category, demo$purchase_category)

# Apply Chi-Square test
chisq.test(table(demo$Age, demo$purchase_category))
```
In the above code, we want to determine whether city stay influences purchase. In Plot 2, we find differences in purchase distribution. Therefore, we want to use a Chi-Square test to see whether this finding is significant. Because the purchase category (new variable created above) is categorical, a Chi-Square test is appropriate.

Based on the evidence from this data set and the result from the Chi-Square test (p-value < 2.2e-16), we believe that the probability that there is no difference among the three cities is less than 5%, and the probability that there is a difference among the three cities is bigger than 95%. Therefore, we reject the null hypothesis, and accept the alternative hypothesis: that there is a difference in purchase distribution between the three cities. Therefore, from this data set, we draw the conclusion that there is an association between the city stay and purchase. 

Conclusion
From our preliminary data analysis, we were able to determine customer demographics that were associated with higher purchase amounts. 