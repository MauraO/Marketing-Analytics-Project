---
title: "Marketing Analytics Project: Black Friday"
author: "Weicheng Zhang, Zilei Zhang, Maura Oray, Gloria Zheng"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r message=FALSE, warning=FALSE}
#Load libraries
library(VIM)
library(readr)
library(tidyverse)
library(dplyr)

BF <- read_csv("BlackFriday.csv")
```

1. Introduction 
Objective:
* Look at the distribution of customer demographics
* Determine which variables are highly correlated with purchase
* Identify which products are high-selling and the characteristics of their customers

2. Data Description
a. Describe the conceptual measure types of the different variables

* User_ID: discrete, nominal
* Product_ID: discrete, nominal
* Gender: discrete, nominal
* Age: discrete, ordinal
* Occupation: discrete, nominal
* City_Category: discrete, nominal
* Stay_in_Current_City_Years: continuous, ratio
* Marital_Status: discrete, nominal
* Product_Category_1: discrete, nominal
* Product_Category_2: discrete, nominal
* Product_Category_3: discrete, nominal
* Purchase: continuous, ratio

b. Mention all the steps you took to clean the data
Step 1. Check if the data contains missing values
```{r message=FALSE, warning=FALSE}
sum(complete.cases(BF))
aggr(BF,cex.axis = .4) #164,278 NA values
```
In the above visualization, we wanted to see which variables had the most NA values. We saw that the NA values were only concentrated in Product Category 2 and Product Category 3.

Step 2. Check the structure of the data
```{r message=FALSE, warning=FALSE}
summary(BF)
str(BF)
```
Step 3. Type coercion
```{r message=FALSE, warning=FALSE}
BF[1:11] = lapply(BF[1:11], factor)
```
The majority of the variables were either integers or characters. We decided to coerce the variables into factors (all except purchase) because the majority of them are categorical. 

Step 4. Tidy the data
```{r message=FALSE, warning=FALSE}
#Demographic data
demo = BF %>% 
  select(-starts_with("Product")) %>%
  group_by(User_ID) %>%
  mutate(Purchase = sum(Purchase))

demo = demo[!duplicated(demo$User_ID), ]
```
3. Summary statistics and Data Visualizations  
** Customer Demographics**  
* The distribution of gender and marital status  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Two way frequency table showing different combinations of customers using gender and marital status  
customer = table(demo$Gender, demo$Marital_Status)
colnames(customer) = c("Unmarried", "Married")
rownames(customer) = c("Female", "Male")

addmargins(customer)
addmargins(prop.table(customer))
```
The two-way frequency table shows 4 combinations of customers. There are 5891 distinct customers in total, and 2470 of them are unmarried males; 1755 are married males; 947 are unmarried females; 719 are married females.  
In this two-way frequency table, we can deduce that there are more unmarried customers (58%) than married (42%) and more male customers (72%) than female (28%). Therefore, in the following analyses regarding gender and marital status, we will focus on customers' average purchase amount instead of the sum purchase, because the sum purchase will easily be influenced by the number of people, which may cause a biased conclusion. 

** Distribution of purchase**
```{r echo=TRUE, message=FALSE, warning=FALSE}
demo %>%
  ggplot(aes(Purchase)) +
  geom_histogram(col = "black", fill = "red1") +
  scale_x_continuous(limits = c(0, 11000000)) +
  theme_minimal() +
  labs(x = "Purchase in dollar", y = "Number of customers", title = "Distribution of purchase")
```

** Purchase disttribution by gender and city**
```{r message=FALSE, warning=FALSE}
demo %>%
  ggplot(aes(x = Purchase, fill = Gender)) +
  geom_histogram() +
  facet_grid(~City_Category) +
  scale_x_continuous(limits = c(0, 3000000)) +
  theme_minimal() +
  labs(x = "Purchase in dollar", y = "Number of customers", title = "Purchase disttribution by gender and city")+
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
```

** Purchase distribution by occupation**
```{r}
demo %>%
  group_by(Occupation)%>%
  ggplot(aes(x = fct_infreq(Occupation), y = sum(Purchase), fill = Marital_Status)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  coord_flip() +
  labs(x = "Occupation", y = "Purchase in Dollar", title = "Purchase Distribution by Occupation")
```

** Purchase distribution by occupation**
```{r}
demo %>%
  ggplot(aes(x = Age, y = Purchase)) +
  geom_boxplot() +
  theme_minimal() +
  labs(x = "Age", y = "Purchase in Dollar", title = "Purchase Distribution by Age")
```

** Purchase distribution by occupation**
```{r message=FALSE, warning=FALSE}
demo %>%
  ggplot(aes(x = Purchase, fill = Gender)) +
  geom_histogram() +
  scale_x_continuous(limits = c(0, 3000000)) +
  theme_minimal() +
  labs(x = "Purchase in dollar", y = "Number of customers", title = "Purchase disttribution by gender")
```

** Purchase distribution by occupation**
```{r message=FALSE, warning=FALSE}
demo %>%
  ggplot(aes(x = Stay_In_Current_City_Years, y = Purchase)) +
  geom_boxplot()+
  theme_minimal() +
  labs(x = "Stay in Current City Years", y = "Purchase", title = "Purchase distribution by stay years")
```

** Whatâ€™s the most popular product category?**
The product category 1 has three most popular product: 5, 1 and 8 - Bar graphs
```{r, echo=TRUE, message=FALSE, warning=FALSE}
BF_prt = BF %>%
  group_by(Product_ID) %>%
  mutate(sumpp = sum(Purchase), avgpp = mean(Purchase))
BF_prt = BF_prt[-c(3:8)]
BF_prt%>%
  ggplot(aes(x = Product_Category_1))+
  geom_bar(aes(x = fct_infreq(as.factor(Product_Category_1))),fill = 'paleturquoise1')
  
```

### 4 Preliminary statistical analyses
```{r}
## Independent t test
# Does men spend more money on Black Friday than women?
t.test(demo[demo$Gender == "M", ]$Purchase,
       demo[demo$Gender == "F", ]$Purchase,
       paired = FALSE,
       alternative = "greater")
```

```{r}
## Independent t test
# Does unmarried customers spend more money on Black Friday than the married?
t.test(demo[demo$Marital_Status == 0, ]$Purchase,
       demo[demo$Marital_Status == 1, ]$Purchase,
       paired = FALSE,
       alternative = "greater")
```

```{r}
### Chi square test
## Is there an association between age and purchase?

# Creat purchase category
demo = demo %>% 
  mutate(purchase_category = cut(Purchase, breaks = c(-Inf, 234914, 512612, 1099005, Inf),
                                        labels = c("low", "middle", "high", "very high")))

# Creat two way frequency table
table(demo$Age, demo$purchase_category)

# Apply chi square test
chisq.test(table(demo$Age, demo$purchase_category))

```

